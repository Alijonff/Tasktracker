Tasktracker — детализированная бизнес-логика (версия 2.2)

Документ описывает полную бизнес-логику системы Tasktracker для разработчиков и агентов (Codex/прочие). Цель — чтобы не приходилось ничего додумывать: все статусы, переходы, аукционы, баллы, отчёты и вложения описаны явно.

Изменения относительно 2.1:
- Администратор вообще не участвует в задачах и аукционах (не создаёт, не делает ставки, не является исполнителем).
- Рост цены/базового времени в аукционах без ставок происходит дискретно каждые 3 часа, от 1.0× до 1.5× за 24 часа.
- Логика задач уровня UNIT изменена с «задача для отдела» на «задача для департамента» (терминология выровнена под фактическое использование департаментного уровня).

--------------------------------
0. Базовые сущности (уровень моделей)
--------------------------------

Это не строгая схема БД, а минимальный набор полей и связей.

0.1. Организационная структура

Department (Департамент)
- id
- name

Division / Management (Управление)
- id
- name
- department_id (может быть null для самостоятельного управления)

Unit / Section (Отдел)
- id
- name
- department_id (если отдел напрямую под департаментом)
- management_id (если отдел под управлением)

0.2. Сотрудники

Employee
- id
- full_name
- grade ∈ {A, B, C, D}
- base_points (стартовые баллы по грейду)
- current_points (текущий рейтинг в баллах)
- department_id
- management_id (опционально)
- unit_id (опционально)
- role (admin, director, deputy_director, head_management, head_unit, senior_staff, staff и пр.)
- is_active (уволен / не уволен)

Грейд определяется ролью при назначении, но логика баллов от задач не меняется задним числом при изменении должности.

0.3. Задачи и аукционы

TaskType
- INDIVIDUAL — индивидуальная для конкретного сотрудника
- UNIT — задача для департамента (через аукцион)
- DEPARTMENT — задача для департамента (через аукцион, может использоваться как «надуровень», если нужно отличать разные типы департаментных задач)

AuctionMode
- MONEY — аукцион по сумме
- TIME — аукцион по времени (минуты)

TaskStatus
- BACKLOG
- IN_PROGRESS
- UNDER_REVIEW
- DONE

Task
- id
- title
- description
- type (см. TaskType)
- auction_mode (nullable; есть только для UNIT/DEPARTMENT задач)
- creator_id (создатель задачи)
- executor_id (исполнитель или null, пока не выбран)
- department_id / management_id / unit_id (область действия задачи)
- min_grade (минимальный грейд участника)
- base_price (для MONEY, изначальная цена)
- base_time_minutes (для TIME, изначальное время в минутах)
- status
- deadline_at
- created_at
- done_at (момент перевода в DONE)

AuctionBid (Ставка)
- id
- task_id
- employee_id
- value_money (для MONEY)
- value_time_minutes (для TIME)
- created_at
- is_active (аннулирована или нет)

TaskResult / Scoring (может быть частью Task либо отдельной сущностью)
- task_id
- base_points (базовые баллы за выполнение)
- penalty_points (штраф за просрочку)
- final_points (итоговые баллы)
- earned_money (для MONEY)
- earned_time_minutes (для TIME)

0.4. Вложения

TaskAttachment
- id
- task_id
- uploader_id
- filename
- filesize_bytes
- created_at
- deleted_at (если файл удалён логически)

0.5. Отчётные агрегаты (логика)

Сами агрегаты могут считаться запросами, материализованными представлениями или периодическими джобами. Важны правила, как считать, а не способ реализации.

-----------------
1. Роли и доступ
-----------------

1.1. Администратор

- Имеет полный доступ к структуре: все департаменты, управления, отделы и сотрудники.
- Может создавать/удалять департаменты, управления, отделы.
- Может назначать и снимать директоров департаментов.
- Может создавать/удалять сотрудников, менять им роли и грейды.
- Может исправлять структурные конфликты (переносы, привязки).

Жёсткое ограничение:
- Админ НЕ участвует в производственных задачах и аукционах:
  - не создаёт задачи;
  - не создаёт аукционы;
  - не делает ставки;
  - не может быть исполнителем задач.
- Админ может видеть всё, но не может быть участником рабочих процессов.

1.2. Директор департамента / Заместитель директора

Ограничены своим департаментом:
- видят и управляют структурой департамента (управления, отделы);
- могут добавлять/удалять сотрудников департамента;
- могут менять должности внутри департамента;
- могут создавать задачи и аукционы уровня департамента (UNIT/DEPARTMENT);
- могут увольнять сотрудников департамента (кроме директора для зама).

Не могут:
- увольнять самого себя (директор);
- назначать директоров департамента (только админ);
- зам не может уволить или назначить директора.

1.3. Руководители управлений и отделов

В классическом случае (управление и отдел внутри департамента):
- не управляют структурой департамента в целом;
- могут иметь повышенный грейд и стартовые баллы;
- могут участвовать в аукционах как исполнители (при условии, что они не админы).

Самостоятельные управления (без департамента):
- действуют как мини-департаменты;
- руководитель и его зам могут создавать задачи и аукционы в рамках своего управления;
- могут управлять структурами внутри управления (если такие есть).

1.4. Обычные и старшие сотрудники

- Могут видеть задачи, доступные их грейду и области (департамент / управление / отдел, в зависимости от типа задачи).
- Могут участвовать в аукционах как исполнители.
- Могут выполнять задачи и получать/терять баллы.
- Не могут менять структуру, роли и увольнять сотрудников.

------------------------------
2. Типы задач и область видимости
------------------------------

2.1. INDIVIDUAL (индивидуальная задача)

- Назначается сразу конкретному сотруднику (executor_id установлен при создании).
- type = INDIVIDUAL, auction_mode = null.
- Статус при создании: IN_PROGRESS.
- Доступ: видят создатель, исполнитель, а также руководители по стандартным правилам доступа.

2.2. UNIT (задача для департамента)

- type = UNIT.
- department_id задаётся обязательно.
- auction_mode ∈ {MONEY, TIME} (обязательно).
- Статус при создании: BACKLOG (открыт аукцион).
- Задачу видят все сотрудники департамента.
- Ставки делать могут только сотрудники этого департамента, чей grade ≥ min_grade и чья роль НЕ admin.

2.3. DEPARTMENT (надуровневая департаментская задача)

- type = DEPARTMENT.
- department_id задаётся обязательно.
- auction_mode ∈ {MONEY, TIME} (обязательно).
- Статус при создании: BACKLOG.
- Задачу видят все сотрудники департамента.
- Ставки могут делать сотрудники департамента с grade ≥ min_grade и ролью, отличной от admin.
- Создатель задачи не может участвовать в аукционе как исполнитель. Если никто не сделает ставку, задача перейдёт к создателю автоматически.

---------------------------------------------
3. Жизненный цикл задачи (статусы и переходы)
---------------------------------------------

3.1. Допустимые статусы

- BACKLOG — задача создана, аукцион открыт (только для UNIT/DEPARTMENT).
- IN_PROGRESS — исполнитель выбран (по аукциону или сразу для INDIVIDUAL).
- UNDER_REVIEW — исполнитель отправил результат, задача на проверке у создателя.
- DONE — задача принята, начислены баллы и вознаграждение.

3.2. Переходы

INDIVIDUAL
- Создание задачи → статус сразу IN_PROGRESS.
- IN_PROGRESS → UNDER_REVIEW — исполнитель отправляет результат.
- UNDER_REVIEW → DONE — создатель принимает работу.
- UNDER_REVIEW → IN_PROGRESS — создатель возвращает на доработку.
- Переоткрытие DONE → что-либо запрещено.

UNIT / DEPARTMENT (аукционные задачи)
- Создание → BACKLOG, аукцион открыт.
- BACKLOG → IN_PROGRESS:
  - при завершении аукциона выбран победитель (по правилам аукциона),
  - либо сработало автоприсвоение создателю.
- IN_PROGRESS → UNDER_REVIEW — исполнитель отправляет результат.
- UNDER_REVIEW → DONE — создатель принимает.
- UNDER_REVIEW → IN_PROGRESS — создатель возвращает на доработку (ставка не меняется).

Важные ограничения
- Статусы меняются только в указанной последовательности, перескакивать нельзя.
- DONE — конечное состояние, переоткрытие не предусмотрено.

----------------------------
4. Аукционы: общие правила
----------------------------

4.1. Общие параметры

При создании аукционной задачи (UNIT/DEPARTMENT):
- задаются: auction_mode, min_grade, область (department_id), deadline_at;
- для MONEY — base_price (исходная цена);
- для TIME — base_time_minutes (исходное время в минутах).

deadline_at всегда задаётся вручную создателем и не зависит от ставок.

4.2. Участие в аукционе

Условие для участия (ставки):
- сотрудник активен (is_active = true);
- принадлежит подходящей области (тот же департамент для задачи);
- его grade ≥ min_grade задачи;
- он не является создателем задачи;
- его роль НЕ admin (админ никогда не участник).

Условия видимости:
- задачей департамента может просматривать любой сотрудник этого департамента;
- делать ставки могут только те, кто удовлетворяет условиям выше.

4.3. Ставки (AuctionBid)

- Для задач MONEY заполняется value_money, для TIME — value_time_minutes.
- Ставка создаётся только в статусе BACKLOG.
- При смене статуса задачи на IN_PROGRESS или выше новые ставки запрещены.

Аннулирование ставок:
- при увольнении сотрудника — все его активные ставки становятся неактивными;
- при переводе в другой департамент — все ставки по задачам старого департамента аннулируются.

--------------------------------------
5. Режим MONEY (аукцион по сумме)
--------------------------------------

5.1. Правила ставок

- Участник предлагает сумму value_money, за которую готов выполнить задачу.
- Система должна запрещать ставку выше текущей лучшей (каждая новая ставка ≤ минимальной существующей).
- Количество аукционов, в которых участвует сотрудник, не ограничено.

5.2. Завершение аукциона

По окончании времени аукциона (по системному таймеру):
- система выбирает минимальную активную ставку;
- если несколько ставок с одинаковой минимальной суммой:
  - выбирается сотрудник с большим current_points на момент завершения аукциона;
- если и сумма, и баллы совпадают:
  - побеждает ставка с более ранним created_at.

Результат:
- executor_id задачи = победитель;
- статус задачи → IN_PROGRESS.

Если ставок нет вообще — см. раздел «Аукцион без ставок».

5.3. Аукцион без ставок (MONEY)

Если до окончания окна аукциона нет ни одной активной ставки:
- base_price увеличивается дискретно, каждые 3 часа, от 1.0× до 1.5× base_price в течение первых 24 часов;
- рост осуществляется ступенчато: коэффициент меняется только каждые 3 часа;
- после достижения потолка 1.5× (через 24 часа от старта роста) значение фиксируется;
- ещё примерно через 3 часа после достижения потолка аукцион закрывается;
- задача автоматически назначается создателю (executor_id = creator_id);
- статус задачи → IN_PROGRESS;
- итоговая цена = текущая увеличенная цена на момент автоприсвоения.

Технически рост может реализовываться через фоновые задачи, Cron и т.п., но бизнес-правило фиксировано: дискретные шаги каждые 3 часа до 1.5× за 24 часа.

5.4. Начисление вознаграждения (MONEY)

При переводе задачи в DONE:
- рассчитываются базовые баллы задачи (по сложности, минимальному грейду и т.п. — формула проектируется отдельно);
- считаются штрафы за просрочку (см. раздел про просрочку);
- final_points = base_points - penalty_points;

Исполнителю начисляются:
- final_points в current_points;
- earned_money = выигранная ставка value_money.

Если задачу в итоге выполняет создатель (через автоприсвоение), он получает всё как обычный исполнитель.

----------------------------------
6. Режим TIME (аукцион по времени)
----------------------------------

6.1. Базовое время

При создании задачи:
- создатель указывает base_time_minutes;
- интерфейс отображает человеку «X часов Y минут», но хранится только число минут.

6.2. Правила ставок (TIME)

- Участник указывает value_time_minutes — время, за которое он готов выполнить задачу.
- Рекомендуется аналогично деньгам запретить ставки, где value_time_minutes > текущей лучшей ставки (чем меньше, тем лучше).

6.3. Завершение аукциона

Правила выбора победителя такие же, как в MONEY, но по value_time_minutes:
- минимальное время;
- при равенстве — больше current_points;
- при равенстве — более ранний created_at.

6.4. Аукцион без ставок (TIME)

Если до окончания окна аукциона нет ставок:
- base_time_minutes увеличивается дискретно, каждые 3 часа, от 1.0× до 1.5× base_time_minutes за первые 24 часа;
- после достижения потолка 1.5× (через 24 часа) значение фиксируется;
- ещё примерно через 3 часа аукцион закрывается;
- задача автоматически назначается создателю;
- статус задачи → IN_PROGRESS;
- итоговое базовое время = увеличенное значение на момент автоприсвоения.

6.5. Начисление вознаграждения (TIME)

При переводе задачи в DONE:
- считаются base_points, penalty_points, final_points так же, как для MONEY;

Исполнителю начисляются:
- final_points в current_points;
- earned_time_minutes = value_time_minutes из выигранной ставки.

Просрочка:
- просрочка не влияет на количество начисляемых минут;
- просрочка влияет только на штраф по баллам.

Деньги в режиме TIME не участвуют.

---------------------------
7. Просрочка и дедлайны
---------------------------

7.1. Просрочка

Если задача в статусе IN_PROGRESS и deadline_at прошёл:
- задача остаётся за тем же исполнителем;
- за каждый час просрочки в рабочее время начисляется −1 балл (штраф);
- штраф копится до момента перевода задачи в DONE.

penalty_points = количество просроченных рабочих часов * (−1).

7.2. Возврат на доработку

Переход UNDER_REVIEW → IN_PROGRESS:
- не создаёт дополнительных штрафов автоматически;
- создатель задачи может изменить дедлайн (оставить прежний или продлить);
- ставка (деньги или время) никогда не меняется после завершения аукциона — сдача на доработку не влияет на ставку.

--------------------------------------------
8. Кадровые изменения: увольнения и переводы
--------------------------------------------

8.1. Увольнение до выбора исполнителя

- Все активные ставки сотрудника аннулируются (is_active = false).

8.2. Увольнение исполнителя

Если сотрудник является исполнителем (executor_id) и увольняется:
- Если задача в статусе IN_PROGRESS:
  - задача автоматически назначается создателю (executor_id = creator_id).
- Если задача в статусе UNDER_REVIEW:
  - создатель может переназначить задачу другому сотруднику (с соблюдением правил доступа).

8.3. Перевод сотрудников

Перевод внутри департамента (между управлениями/отделами):
- активные ставки по департаментским задачам остаются;
- активные ставки по задачам тех подразделений, в которых сотрудник больше не числится (если такие задачи появятся отдельно), должны быть аннулированы по отдельной логике.

Перевод в другой департамент:
- все активные ставки по задачам старого департамента аннулируются.

Логика аннулирования должна быть реализована в сервисах, реагирующих на события HR (увольнение/перевод).

-----------------------
9. Вложения файлов
-----------------------

9.1. Кому доступны вложения

Прикрепление файлов:
- Создатель задачи:
  - может прикреплять файлы на любом этапе (BACKLOG, IN_PROGRESS, UNDER_REVIEW, DONE — если политика компании позволяет изменять историю).
- Исполнитель задачи:
  - может прикреплять файлы, начиная со статуса IN_PROGRESS и пока задача не в DONE.

Удаление файлов:
- Файл может удалить только тот, кто имеет право прикреплять файлы на текущем этапе:
  - создатель задачи — свои и, по решению бизнеса, любые файлы задачи;
  - исполнитель — только свои файлы (рекомендуемое ограничение).

Минимум: создатель может управлять всеми вложениями задачи.

9.2. Ограничения

- Максимум 10 файлов на задачу (активных, не удалённых).
- Максимальный размер одного файла — 25 МБ.
- Типы файлов не ограничены бизнес-логикой (ограничения по безопасности/формату — на уровне инфраструктуры).

9.3. Привязка и отображение

- Вложения привязаны к задаче (task_id).
- К ставкам (AuctionBid) файлы не привязываются.
- Все вложения задачи видны тем, кто имеет право видеть задачу (создатель, исполнитель, руководители и т.п.).
- Удаление может быть логическим (deleted_at), чтобы не ломать историю.

-----------------------------
10. Отчётность и агрегаты
-----------------------------

10.1. Принципы

- В отчёты попадают только задачи в статусе DONE.
- Месяц определяется по дате done_at (момент завершения задачи).

Для каждой завершённой задачи фиксируется:
- executor_id;
- его department_id, management_id, unit_id на момент выполнения;
- final_points;
- earned_money (если есть);
- earned_time_minutes (если есть);
- penalty_points (по необходимости).

10.2. Отчёты по сотрудникам

Для каждого сотрудника и каждого календарного месяца:
- количество завершённых задач;
- суммарная earned_money;
- суммарная earned_time_minutes;
- суммарные final_points.

В интерфейсе можно выводить:
- текущий месяц;
- прошлый месяц;
- любой выбранный месяц.

10.3. Отчёты по структуре

Агрегация по структуре для каждого календарного месяца:
- Департамент — по задачам всех сотрудников департамента, включая департаментный уровень (директор, зам, сотрудники без отдела);
- Управление — по задачам сотрудников управления и его отделов (если используются);
- Отдел — по задачам сотрудников конкретного отдела (если используются задачи такого уровня).

Считаются:
- количество задач;
- суммарные деньги;
- суммарное время;
- суммарные баллы.

-------------------
11. Финальные правила
-------------------

- Статус DONE — конечный, переоткрытие задач не допускается; новая работа = новая задача.
- Время всегда хранится в минутах, отображение в часах/минутах — задача UI.
- Деньги и время не смешиваются в одной задаче: аукцион либо MONEY, либо TIME.
- Админ не участвует в задачах и аукционах, только управляет структурой и пользователями.
- Этот документ является основной точкой истины для реализации бизнес-логики Tasktracker. Любые расхождения кода с этой логикой считаются багами и должны устраняться путём приведения кода к этим правилам.

